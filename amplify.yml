frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸ§  Determining environment based on AWS_BRANCH..."
        - |
          case "$AWS_BRANCH" in
            "staging") 
              echo "ðŸ§ª STAGING detected"
              export BUILD_ENV=staging
              ;;
            "main") 
              echo "ðŸŸ¢ MAIN detected"
              export BUILD_ENV=main
              ;;
            *)
              echo "âš ï¸ Invalid branch for deployment. Only 'staging' or 'main' branches are allowed."
              exit 1
              ;;
          esac
        - echo "âœ… Environment set to $BUILD_ENV"
        - npm ci

    build:
      commands:
        - echo "âš™ï¸ Running build for $BUILD_ENV"
        - npm run build
        - echo "ðŸš€ Build complete"

    postBuild:
      commands:
        - echo "ðŸš€ Preparing to run Cypress Tests..."
        - |
          if [[ "$BUILD_ENV" =~ ^(staging|main)$ ]]; then
            echo "ðŸ§ª Starting server for Cypress tests..."
            npm run start &  # Start your server in background
            echo $! > server.pid  # Save the process ID
            npx wait-on http://localhost:8081  # Adjust the port if needed
            echo "ðŸ§ª Server is ready! Running Cypress tests..."
            npm run test:ci  # Run Cypress tests
            kill $(cat server.pid)  # Stop the server
            echo "ðŸ›‘ Server stopped after tests"
          else
            echo "ðŸŸ¢ Skipping Cypress tests for unsupported branch."
          fi
        - echo "âœ… Post-build tasks complete"

  artifacts:
    baseDirectory: .next
    files:
      - '**/*'

  cache:
    paths:
      - node_modules/**/*
